# 4단계 조합 필터 성능 악화 원인 조사 결과

## 문제 상황
- 필터 적용 시: **승률 44.5%, 총 수익 +256,700원**
- 필터가 성능을 개선하기는커녕 오히려 악화시킴

## 조사 결과

### 1. 필터 작동 통계
진단 스크립트로 확인한 결과, 필터는 정상적으로 작동하고 있었습니다:

```
총 패턴: 40,694개
필터 활성화: 22,620회 (55.6%)
  - 가점 부여: 1,233회 (5.5%)
  - 감점 부여: 21,387회 (47.5%)
  - 차단: 8,375회 (18.6%)
```

**문제점:** 필터가 전체 패턴의 55.6%에 개입하며, 그 중 94.5%를 감점/차단했습니다.

### 2. 근본 원인: 잘못된 필터 설계

#### 원인 1: 부분 매칭으로 인한 과도한 차단

필터는 **부분 패턴**만 일치해도 감점/차단을 적용했습니다:

**예시 1: "돌파-음봉" 전면 차단**
```python
# 필터 규칙
{'돌파': '음봉', 'penalty': -100}  # 무조건 차단
```

실제 데이터:
```
상승-강함 + 하락-적정 + 지지-매우안정 + 돌파-음봉  → 61건, 승률 75.4% ❌ 차단됨
상승-강함 + 하락-강함 + 지지-매우안정 + 돌파-음봉  → 20건, 승률 70.0% ❌ 차단됨
상승-과열 + 하락-강함 + 지지-매우안정 + 돌파-음봉  → 30건, 승률 63.3% ❌ 차단됨
상승-적정 + 하락-적정 + 지지-매우안정 + 돌파-음봉  → 76건, 승률 56.6% ❌ 차단됨
```

→ **고승률 패턴을 대량 차단**

0% 승률 조합은 단 2개뿐:
```
상승-적정 + 하락-강함 + 지지-매우안정 + 돌파-음봉  → 9건, 승률 0%
상승-적정 + 하락-약함 + 지지-안정 + 돌파-음봉    → 8건, 승률 0%
```

**예시 2: "하락-급락" 전면 감점**
```python
# 필터 규칙
{'하락': '급락(4%+)', 'penalty': -30}
```

실제 데이터:
```
상승-강함 + 하락-급락 + 지지-매우안정 + 돌파-급등  → 13건, 승률 100% ❌ 감점됨
상승-적정 + 하락-급락 + 지지-매우안정 + 돌파-음봉  → 1건, 승률 100% ❌ 감점됨
상승-과열 + 하락-급락 + 지지-안정 + 돌파-강함     → 5건, 승률 100% ❌ 감점됨
상승-적정 + 하락-급락 + 지지-매우안정 + 돌파-급등  → 9건, 승률 88.9% ❌ 감점됨
```

→ **고승률 패턴에 감점 부여**

#### 원인 2: 단일 특성으로 전체 패턴 판단

4단계 조합의 핵심은 **모든 단계의 상호작용**입니다.
- "돌파-음봉"만으로는 승패를 예측할 수 없음
- 상승/하락/지지 단계와의 **조합**이 중요

필터는 이를 무시하고 단일 특성만으로 차단했습니다.

#### 원인 3: 분석 결과의 잘못된 해석

분석에서 "돌파-음봉 전체의 평균 승률 33.7%"를 발견했다고 해서
**모든 돌파-음봉을 차단**하는 것은 잘못된 일반화입니다.

평균은 낮지만 **특정 조합에서는 70%+ 승률**을 기록합니다.

## 해결 방안

### 방안 1: 현재 필터 제거 ✅ (권장)
- 현재 four_stage_combination_filter.py는 주석 처리됨
- 제거하고 필터 없이 운영하는 것이 더 나음

### 방안 2: 정밀 필터(V2) 사용
새로 작성한 `four_stage_combination_filter_v2.py`:
- **완전한 4단계 조합만 매칭** (부분 매칭 금지)
- **충분한 거래 수**(10건 이상) + **실제 손실 조합**만 차단
- 예:
  - ✅ 차단: "상승-과열 + 하락-급락 + 지지-매우안정 + 돌파-급등" (10건, 0%)
  - ❌ 차단 안 함: "상승-강함 + 하락-급락 + 지지-매우안정 + 돌파-급등" (13건, 100%)
- 고승률 조합: 3개만 선정 (보수적 접근)
- 저승률 조합: 8개만 차단 (정밀 타겟팅)

### 방안 3: PatternCombinationFilter 사용
이전에 작성한 `pattern_combination_filter.py`:
- 3단계 조합(상승강도, 하락정도, 지지길이)만 사용
- **실제 총 수익이 마이너스인 조합**만 제외
- 예상 효과: 승률 +4.0%p, 평균 수익 +68.3%
- 더 검증된 접근 방식

## 권장 사항

1. **즉시 조치**: 현재 필터는 제거된 상태 유지 ✅
2. **추가 테스트**:
   - 옵션 A: 필터 없이 계속 운영 (가장 안전)
   - 옵션 B: `pattern_combination_filter.py` 테스트 (검증된 방식)
   - 옵션 C: `four_stage_combination_filter_v2.py` 테스트 (정밀 필터)

3. **검증 방법**:
   ```bash
   # 필터 없이 백테스트
   python batch_signal_replay.py --start-date 20250901 --end-date 20251114

   # 새 필터로 백테스트
   # pullback_candle_pattern.py에서 V2 필터 적용 후
   python batch_signal_replay.py --start-date 20250901 --end-date 20251114
   ```

4. **비교 기준**:
   - 승률
   - 총 수익
   - 평균 수익
   - 필터 활성화율
   - 차단된 거래 중 실제 승리 비율

## 파일 목록

### 조사 관련
- `diagnose_filter_activation.py` - 필터 작동 진단
- `analyze_filter_correctness.py` - 필터 정확도 분석
- `compare_filter_vs_analysis.py` - 필터 vs 분석 결과 비교
- `FILTER_PROBLEM_ANALYSIS.md` - 상세 문제 분석

### 필터 파일
- `core/indicators/four_stage_combination_filter.py` - V1 (문제 있음, 현재 주석 처리)
- `core/indicators/four_stage_combination_filter_v2.py` - V2 (정밀 필터, 새로 작성)
- `core/indicators/pattern_combination_filter.py` - 3단계 조합 필터 (검증됨)

### 테스트
- `test_four_stage_filter.py` - 필터 단위 테스트
