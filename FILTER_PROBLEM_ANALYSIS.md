# 4단계 조합 필터 문제 분석

## 문제 요약

4단계 조합 필터를 적용한 결과, 성능이 오히려 악화되었습니다:
- **필터 적용 후**: 승률 44.5%, 총 수익 +256,700원
- **필터 미적용**: (더 나은 성능)

## 근본 원인

필터가 **과도하게 넓은 규칙**을 적용하여 많은 고승률 패턴을 잘못 차단하고 있습니다.

### 문제 1: "돌파-음봉" 전면 차단의 오류

필터는 모든 "돌파-음봉" 패턴에 -100 감점 (즉시 차단)을 적용합니다.

하지만 실제 데이터를 보면:
```
상승-강함 + 하락-적정 + 지지-매우안정 + 돌파-음봉  → 61건, 승률 75.4%
상승-강함 + 하락-강함 + 지지-매우안정 + 돌파-음봉  → 20건, 승률 70.0%
상승-과열 + 하락-강함 + 지지-매우안정 + 돌파-음봉  → 30건, 승률 63.3%
상승-과열 + 하락-급락 + 지지-매우안정 + 돌파-음봉  → 5건, 승률 60.0%
상승-적정 + 하락-적정 + 지지-매우안정 + 돌파-음봉  → 76건, 승률 56.6%
상승-강함 + 하락-약함 + 지지-매우안정 + 돌파-음봉  → 77건, 승률 55.8%
```

**필터는 이 모든 고승률 패턴을 차단했습니다!**

0% 승률을 가진 음봉 조합은 단 2개뿐입니다:
```
상승-적정 + 하락-강함 + 지지-매우안정 + 돌파-음봉  → 9건, 승률 0%
상승-적정 + 하락-약함 + 지지-안정 + 돌파-음봉    → 8건, 승률 0%
```

### 문제 2: "하락-급락" 전면 감점의 오류

필터는 모든 "하락-급락(4%+)" 패턴에 -30 감점을 적용합니다.

하지만 실제 데이터를 보면:
```
상승-강함 + 하락-급락 + 지지-매우안정 + 돌파-급등  → 13건, 승률 100%
상승-적정 + 하락-급락 + 지지-매우안정 + 돌파-음봉  → 1건, 승률 100%
상승-과열 + 하락-급락 + 지지-안정 + 돌파-강함     → 5건, 승률 100%
상승-적정 + 하락-급락 + 지지-매우안정 + 돌파-적정  → 3건, 승률 100%
상승-적정 + 하락-급락 + 지지-매우안정 + 돌파-급등  → 9건, 승률 88.9%
```

**필터는 이 모든 고승률 패턴에 감점을 부여했습니다!**

### 문제 3: "상승-과열 + 하락-급락" 조합 차단의 모호함

필터는 "상승-과열(7%+) + 하락-급락(4%+)" 조합에 -100 감점(차단)을 적용합니다.

이는 너무 넓은 규칙입니다. 이 조합의 실제 성능은 **다른 2단계(지지, 돌파)에 따라 완전히 달라집니다**.

## 필터 작동 통계

진단 스크립트 결과:
```
총 패턴 수: 40,694
필터 활성화: 22,620회 (55.6%)
  - 가점 부여: 1,233회
  - 감점 부여: 21,387회
  - 차단: 8,375회
```

**문제점:**
- 55.6%의 패턴에 필터가 개입
- 그 중 94.5%가 감점/차단 (21,387 + 8,375 / 22,620)
- 가점은 단 5.5%만 (1,233 / 22,620)
- **8,375개의 패턴이 차단됨** → 이 중 많은 수가 고승률 패턴

## 결론

현재 필터는 다음과 같은 치명적인 설계 오류가 있습니다:

1. **단일 특성으로 전체 패턴을 판단**
   - "돌파-음봉"이면 무조건 차단 → 잘못됨
   - "하락-급락"이면 무조건 감점 → 잘못됨
   - **4단계 조합은 모든 단계의 상호작용으로 결정되어야 함**

2. **분석 결과를 잘못 해석**
   - 분석에서 "돌파-음봉 전체의 평균 승률 33.7%"를 발견했다고
   - "모든 돌파-음봉을 차단"하는 것은 잘못된 일반화
   - **구체적인 4단계 조합으로 필터링해야 함**

3. **과도한 필터 활성화**
   - 55.6%의 패턴에 개입하며 그 중 94.5%를 감점/차단
   - 이는 필터가 아니라 거의 모든 거래를 막는 수준

## 권장 사항

### 옵션 1: 필터 제거
현재 필터는 해보다 득이 많으므로 제거하는 것이 나음

### 옵션 2: 필터 재설계
- **완전한 4단계 조합만 필터링** (부분 매칭 금지)
- 예: "상승-적정 + 하락-강함 + 지지-매우안정 + 돌파-음봉 = 0% 승률" → 차단
- 예: "상승-강함 + 하락-적정 + 지지-매우안정 + 돌파-음봉 = 75.4% 승률" → 가점
- **충분한 거래 수 확보** (최소 10건 이상)
- **실제 총 수익이 마이너스인 조합만 차단**

### 옵션 3: PatternCombinationFilter 사용
이전에 만든 `pattern_combination_filter.py`는 더 나은 접근 방식을 사용:
- 3단계 조합만 사용 (상승강도, 하락정도, 지지길이)
- **실제 총 수익이 마이너스인 조합**만 제외
- 예상 개선: 승률 +4.0%p, 평균 수익 +68.3%

이 필터를 대신 테스트해볼 것을 권장합니다.
