# ML 모델 V2 분석 리포트

**생성일**: 2025-11-21
**목적**: 일봉 데이터 및 기술적 지표를 포함한 V2 모델의 성능 분석

---

## 📊 1. 데이터셋 비교

### V1 (패턴만)
- **샘플 수**: 9,376개
- **특성 수**: 26개
- **승률**: 49.7% (승리 4,664 / 패배 4,712)
- **특성 구성**: 패턴 특성만 사용

### V2 (패턴 + 일봉)
- **샘플 수**: 9,358개
- **특성 수**: 62개
- **승률**: 49.8% (승리 4,664 / 패배 4,694)
- **특성 구성**:
  - 패턴 특성: 34개
  - 일봉/기술지표: 28개

---

## 🎯 2. 모델 성능 비교

| 지표 | V1 (패턴만) | V2 (패턴+일봉) | 변화 |
|------|------------|---------------|------|
| **교차 검증 AUC** | N/A | 0.9909 ± 0.0014 | - |
| **테스트 AUC** | 0.5490 | 0.5021 | 🔻 -0.0469 |
| **테스트 정확도** | N/A | 44% | - |
| **특성 수** | 26개 | 62개 | +36개 (+138%) |

### 🚨 주요 문제점

1. **과적합 발생**
   - 교차 검증: 99.09% (매우 높음)
   - 테스트: 50.21% (급락)
   - **차이**: 약 49%p → 심각한 과적합

2. **성능 하락**
   - V1보다 테스트 AUC가 **4.69%p 감소**
   - 일봉 데이터 추가가 오히려 역효과

3. **특성 활용도 불균형**
   - 패턴 특성 중요도: **95.0%**
   - 일봉/기술지표 중요도: **5.0%**
   - 추가된 28개 특성이 거의 활용되지 않음

---

## 📈 3. 특성 중요도 분석

### Top 10 중요 특성 (V2)

| 순위 | 특성 | 중요도 | 타입 |
|------|------|--------|------|
| 1 | decline_pct | 1,610 | 패턴 |
| 2 | decline_avg_volume | 1,213 | 패턴 |
| 3 | support_avg_volume_ratio | 1,081 | 패턴 |
| 4 | breakout_volume | 1,002 | 패턴 |
| 5 | support_avg_volume | 1,000 | 패턴 |
| 6 | uptrend_gain | 823 | 패턴 |
| 7 | uptrend_max_volume | 819 | 패턴 |
| 8 | volume_ratio_breakout_to_uptrend | 810 | 패턴 |
| 9 | price_gain_to_decline_ratio | 774 | 패턴 |
| 10 | volume_ratio_support_to_uptrend | 528 | 패턴 |

**관찰**:
- Top 10이 모두 패턴 특성
- 일봉/기술지표는 16위(volume_ma20)부터 등장

### 일봉/기술지표 중요도 (상위 5개)

| 순위 | 특성 | 중요도 | 전체 순위 |
|------|------|--------|-----------|
| 1 | volume_ma20 | 238 | 16위 |
| 2 | macd_signal | 175 | 19위 |
| 3 | price_change_20d | 164 | 21위 |
| 4 | macd_histogram | 80 | 24위 |
| 5 | volatility_20d | 68 | 27위 |

### 중요도 0인 특성 (23개)

다음 특성들이 전혀 사용되지 않음:
- 시간 관련: `hour`, `minute`, `time_in_minutes`, `is_morning`
- 일봉 가격: `daily_high`, `price_change_1d`
- 볼륨: `volume_change_1d`, `volume_surge`
- RSI: `rsi_oversold`, `rsi_overbought`
- 이동평균: `ma5`, `ma10`, `ma20`, `ma60`
- 볼린저밴드: `bb_middle`, `bb_lower`
- 기타: `signal_type`, `macd_positive`, `high_low_ratio`, etc.

---

## 🔍 4. 실전 백테스트 결과 (V1 모델 기준)

현재 실전에서는 **V1 모델**을 사용하고 있으며, 다음과 같은 결과를 보임:

### 원본 (필터 없음) vs ML 필터 적용 (V1)

| 항목 | 원본 | ML 필터 적용 | 개선 |
|------|------|-------------|------|
| **총 신호** | 591개 | 403개 | -188개 (-31.8%) |
| **승리 거래** | 266개 | 221개 | -45개 |
| **패배 거래** | 325개 | 182개 | -143개 |
| **승률** | 45.0% | **54.8%** | **+9.8%p** |
| **평균 수익률** | 0.09% | **0.59%** | **+0.49%p** |
| **총 수익률** | 54.14% | **235.88%** | **+181.74%** |

### ML 필터 효과 (V1)

✅ **차단 효율성**: 188개 신호 차단 중 143개가 패배 (76.1%)
✅ **승률 향상**: 45.0% → 54.8% (+9.8%p)
✅ **수익성 개선**: 총 수익률 4.4배 증가

---

## 💡 5. 문제 원인 분석

### 5.1 데이터 품질 문제

1. **일봉 데이터 수집 범위**
   - 수집된 데이터: 2,212건 (276개 종목)
   - 데이터셋 샘플: 9,358개
   - **매칭률**: 약 23.6%
   - 일부 패턴에 대해 일봉 데이터가 없어 0으로 채워졌을 가능성

2. **데이터 불균형**
   ```
   학습 세트: 54.3% 승률
   검증 세트: 49.4% 승률
   테스트 세트: 36.8% 승률 ⚠️
   ```
   - 테스트 세트의 승률이 유독 낮음 (시간 기반 분할의 문제)

### 5.2 모델 설계 문제

1. **특성 엔지니어링 실패**
   - 28개 일봉 특성 중 23개가 중요도 0
   - 추가된 특성이 예측력이 없거나 노이즈로 작용

2. **과적합**
   - 특성이 26개 → 62개로 증가 (2.4배)
   - 샘플 수는 거의 동일 (9,376 → 9,358)
   - 특성 대비 샘플 비율 악화

3. **학습 파라미터**
   - Early stopping: 11번 반복에서 조기 종료
   - 학습이 제대로 진행되지 않음

---

## 🎯 6. 결론 및 권장사항

### 결론

**V2 모델(패턴+일봉)은 V1 모델(패턴만)보다 성능이 떨어집니다.**

- V1 테스트 AUC: 0.5490
- V2 테스트 AUC: 0.5021
- **차이**: -0.0469 (-8.5%)

### 권장사항

#### ✅ 단기: V1 모델 유지

현재 **V1 모델을 계속 사용**하는 것이 최선:
- 테스트 성능이 더 우수
- 실전 백테스트에서 입증됨 (승률 54.8%)
- 단순하고 안정적

#### 🔬 중장기: V2 개선 방향

V2를 개선하려면 다음 작업 필요:

1. **데이터 품질 개선**
   - 모든 패턴에 대해 일봉 데이터 확보
   - 결측치 처리 방법 개선 (0 대신 다른 방법)

2. **특성 선택**
   - 중요도 0인 23개 특성 제거
   - 상관관계 높은 특성 제거
   - 타겟 변수와 실제 상관관계 분석

3. **모델 파라미터 조정**
   - 정규화 강화 (lambda_l1, lambda_l2 증가)
   - max_depth 감소
   - min_data_in_leaf 증가

4. **데이터 분할 전략 변경**
   - 테스트 세트 승률이 36.8%로 너무 낮음
   - 시간 기반 대신 Stratified 분할 고려
   - 또는 더 긴 기간 데이터 수집

5. **일봉 데이터 활용 개선**
   - 60일 전체 데이터 대신 핵심 지표만 사용
   - 패턴 발생 시점 기준 상대적 위치 추가
   - 추세 강도, 모멘텀 등 고차원 특성 생성

---

## 📊 7. 다음 단계

### 우선순위 1: V1 모델 최적화
- Threshold 조정 (현재 0.5)
- 추가 백테스트로 안정성 검증

### 우선순위 2: 데이터 분석
- 테스트 세트 승률이 낮은 원인 분석
- 시간대별, 종목별 패턴 분석

### 우선순위 3: V2 재설계 (선택사항)
- 위의 개선 방향 적용
- 작은 범위부터 단계적 개선

---

## 📁 8. 생성된 파일

- `ml_dataset_v2.csv`: V2 데이터셋 (9,358 샘플, 62 특성)
- `ml_model_v2.pkl`: V2 학습 모델 (40.6 KB)
- `ml_results_v2/`:
  - `roc_curve_v2.png`: ROC 곡선
  - `feature_importance_v2.png`: 특성 중요도 시각화
  - `feature_importance_v2.csv`: 특성 중요도 데이터
- `cache/daily_data/`: 일봉 데이터 캐시 (2,212개 파일)

---

**최종 권장**: 현재는 **V1 모델을 계속 사용**하고, V2는 추가 개선 작업 후 재검토
