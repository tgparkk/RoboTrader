# 마이너스 수익 조합 필터 적용 가이드

## 개요

`analyze_negative_profit_combinations.py` 분석 결과를 바탕으로 총 수익이 마이너스인 11개의 4단계 패턴 조합을 자동으로 필터링합니다.

### 기대 효과
- **총 수익: +31.3% 증가** (156.35% → 205.33%)
- **평균 수익률: +68.3% 증가** (0.286% → 0.482%)
- **승률: +4.0%p 증가** (49.1% → 53.1%)
- **거래 수: 22.0% 감소** (546건 → 426건)

## 이미 적용 완료!

필터는 **이미 `pullback_pattern_validator.py`에 통합되어 있습니다.**

### 적용된 위치

```
core/indicators/pullback_pattern_validator.py
```

### 동작 방식

1. **패턴 신뢰도 체크** (confidence < 40%)
2. **마이너스 수익 조합 필터링** ← 새로 추가!
3. 기존 품질 검증 로직

필터는 `validate_pattern()` 메서드 내에서 최우선으로 체크됩니다.

## 제외되는 조합 (11개)

### 손실 큰 순서:

1. **약함(<4%) + 보통(1.5-2.5%) + 짧음(≤2)**
   - 34건, 승률 32.4%, 총 손실 -15.38%

2. **강함(>6%) + 얕음(<1.5%) + 보통(3-4)**
   - 7건, 승률 14.3%, 총 손실 -9.73%

3. **보통(4-6%) + 얕음(<1.5%) + 보통(3-4)**
   - 15건, 승률 40.0%, 총 손실 -5.52%

4. **강함(>6%) + 깊음(>2.5%) + 짧음(≤2)**
   - 36건, 승률 41.7%, 총 손실 -4.53%

5. **강함(>6%) + 보통(1.5-2.5%) + 보통(3-4)**
   - 4건, 승률 25.0%, 총 손실 -4.00%

6. **보통(4-6%) + 깊음(>2.5%) + 보통(3-4)**
   - 1건, 승률 0.0%, 총 손실 -2.50%

7. **약함(<4%) + 보통(1.5-2.5%) + 보통(3-4)**
   - 1건, 승률 0.0%, 총 손실 -2.50%

8. **약함(<4%) + 보통(1.5-2.5%) + 김(>4)**
   - 4건, 승률 25.0%, 총 손실 -1.83%

9. **강함(>6%) + 깊음(>2.5%) + 김(>4)**
   - 3건, 승률 33.3%, 총 손실 -1.50%

10. **보통(4-6%) + 보통(1.5-2.5%) + 김(>4)**
    - 3건, 승률 33.3%, 총 손실 -1.50%

11. **약함(<4%) + 깊음(>2.5%) + 짧음(≤2)**
    - 12건, 승률 41.7%, 총 손실 -0.00%

## 통과하는 조합 (좋은 조합)

### 최고 성과 조합:

**보통(4-6%) + 보통(1.5-2.5%) + 짧음(≤2)**
- 33건, 승률 66.7%, 총 수익 +55.12%

**강함(>6%) + 보통(1.5-2.5%) + 짧음(≤2)**
- 성과 좋음

**보통(4-6%) + 깊음(>2.5%) + 짧음(≤2)**
- 성과 좋음

## 실전 사용

### 자동 적용

필터는 이미 통합되어 있으므로 **별도의 설정 없이 자동으로 작동**합니다.

봇 실행 시 다음과 같은 로그가 출력됩니다:

```
🚫 마이너스 수익 조합: 약함(<4%) + 보통(1.5-2.5%) + 짧음(≤2)
```

### 필터 비활성화 (테스트용)

만약 필터를 임시로 비활성화하려면:

```python
# pullback_pattern_validator.py에서 다음 부분을 주석 처리
# if debug_info:
#     should_exclude, exclude_reason = self.combination_filter.should_exclude(debug_info)
#     if should_exclude:
#         ...
```

## 테스트

필터가 올바르게 작동하는지 테스트:

```bash
python test_combination_filter.py
```

예상 결과:
- 테스트 1, 2, 5: 제외됨 (True)
- 테스트 3, 4: 통과 (False)

## 분석 파일

### 생성된 CSV 파일:

1. **pattern_combinations_by_profit.csv**
   - 전체 23개 조합의 수익 분석
   - 총 수익 기준 정렬

2. **negative_profit_combinations.csv**
   - 제외할 11개 조합 목록
   - 필터 구현 시 참조용

## 코드 구조

```
core/indicators/
├── pattern_combination_filter.py          # 필터 로직 (새로 추가)
└── pullback_pattern_validator.py          # 필터 통합 (수정됨)

analyze_negative_profit_combinations.py     # 분석 스크립트
test_combination_filter.py                  # 테스트 스크립트
```

## 추가 분석

최소 거래 수 임계값을 변경하여 필터를 조정할 수 있습니다:

```bash
python analyze_negative_profit_combinations.py
```

출력 결과:
- 최소 1건: +48.98% (11개 조합 제외) ← 현재 적용
- 최소 3건: +43.98% (9개 조합 제외)
- 최소 5건: +35.15% (5개 조합 제외)
- 최소 10건: +25.42% (4개 조합 제외)

## 주의사항

1. **과거 데이터 기반**: 2025년 9월~11월 데이터로 분석
2. **조합만 필터링**: 신뢰도, 거래량 등 다른 조건은 기존과 동일
3. **백테스트 권장**: 실전 적용 전 최근 데이터로 재검증 권장

## 모니터링

실전 운영 시 다음을 모니터링하세요:

1. **필터링 비율**: 전체 시그널 대비 제외 비율 (~22%)
2. **승률 변화**: 49.1% → 53.1% 유지 여부
3. **평균 수익률**: 0.286% → 0.482% 유지 여부

## 결론

이 필터는 **데이터 기반**으로 검증된 방법으로, 기존 승률 필터나 임계값 필터와 달리 **실제 수익을 증가**시킵니다.

- ❌ 하락률 필터: -4% ~ -42% 손실
- ❌ 지지 캔들 필터: -4.4% 손실
- ✅ **마이너스 조합 필터: +31.3% 증가!**
