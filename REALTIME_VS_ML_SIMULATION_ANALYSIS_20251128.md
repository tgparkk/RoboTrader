# 실시간 거래 vs ML 시뮬레이션 차이 분석 (2025-11-28)

## 📊 전체 요약

| 구분 | 거래 건수 | 승/패 | 승률 | 총 수익 |
|------|-----------|-------|------|---------|
| **기본 시뮬레이션** | 16건 | 8승 8패 | 50.0% | +107,568원 |
| **ML 시뮬레이션** | 11건 | 7승 4패 | 63.6% | +155,900원 |
| **실시간 거래** | 1건 | 1승 0패 | 100% | +28,595원 |

---

## 🔍 전체 16건 거래 상세 분석

### ML 필터링 기준: 50% (threshold=0.5)

| # | 시간 | 종목 | 결과 | 수익률 | ML 예측 | 필터 | 실시간 |
|---|------|------|------|--------|---------|------|--------|
| 1 | 09:30 | 058610 | ❌ 패배 | -2.50% | 65.9% | ✅ 통과 | ❌ 미체결 |
| 2 | 09:39 | 308080 | ❌ 패배 | -2.50% | 69.0% | ✅ 통과 | ❌ 미체결 |
| 3 | 09:54 | 950160 | ✅ 승리 | +3.50% | 63.4% | ✅ 통과 | ✅ **체결 (09:56)** |
| 4 | 10:03 | 092200 | ❌ 패배 | -2.50% | 64.6% | ✅ 통과 | ❌ 미체결 |
| 5 | 10:09 | 448900 | ❌ 패배 | -2.50% | 41.2% | 🚫 차단 | ❌ 미체결 |
| 6 | 10:12 | 102940 | ✅ 승리 | +3.50% | 61.8% | ✅ 통과 | ❌ 미체결 |
| 7 | 10:15 | 058610 | ✅ 승리 | +3.50% | 45.1% | 🚫 차단 | ❌ 미체결 |
| 8 | 10:18 | 123410 | ❌ 패배 | -0.83% | 28.7% | 🚫 차단 | ❌ 미체결 |
| 9 | 10:24 | 950160 | ✅ 승리 | +3.50% | 71.2% | ✅ 통과 | ❌ 미체결 |
| 10 | 10:36 | 214370 | ❌ 패배 | -2.50% | 18.7% | 🚫 차단 | ❌ 미체결 |
| 11 | 10:39 | 085660 | ❌ 패배 | -1.41% | 69.3% | ✅ 통과 | ❌ 미체결 |
| 12 | 10:45 | 115180 | ❌ 패배 | -2.50% | 37.5% | 🚫 차단 | ❌ 미체결 |
| 13 | 10:54 | 448900 | ✅ 승리 | +3.50% | 50.0% | ✅ 통과 (패턴없음) | ❌ 미체결 |
| 14 | 11:06 | 098460 | ✅ 승리 | +3.50% | 50.0% | ✅ 통과 (패턴없음) | ❌ 미체결 |
| 15 | 11:30 | 327260 | ✅ 승리 | +3.50% | 50.0% | ✅ 통과 (패턴없음) | ❌ 미체결 |
| 16 | 11:48 | 448900 | ✅ 승리 | +3.50% | 50.0% | ✅ 통과 (패턴없음) | ❌ 미체결 |

---

## 🎯 ML 필터링 효과 분석

### 차단된 5건 (31.2%)
| 시간 | 종목 | 실제 결과 | ML 예측 | 차단 효과 |
|------|------|-----------|---------|-----------|
| 10:09 | 448900 | ❌ -2.50% | 41.2% | ✅ **손실 방지** |
| 10:15 | 058610 | ✅ +3.50% | 45.1% | ❌ 수익 기회 상실 |
| 10:18 | 123410 | ❌ -0.83% | 28.7% | ✅ **손실 방지** |
| 10:36 | 214370 | ❌ -2.50% | 18.7% | ✅ **손실 방지** |
| 10:45 | 115180 | ❌ -2.50% | 37.5% | ✅ **손실 방지** |

**차단 효과:**
- ✅ 손실 방지: 4건 (-8.33%)
- ❌ 수익 상실: 1건 (+3.50%)
- **순 효과: +4.83% 손실 방지**

### 통과된 11건 (68.8%)
| 결과 | 건수 | 비율 |
|------|------|------|
| ✅ 승리 | 7건 | 63.6% |
| ❌ 패배 | 4건 | 36.4% |

**주요 패배 케이스:**
1. **058610 (09:30)**: ML 65.9% 예측 → 실제 -2.50%
2. **308080 (09:39)**: ML 69.0% 예측 → 실제 -2.50%
3. **092200 (10:03)**: ML 64.6% 예측 → 실제 -2.50%
4. **085660 (10:39)**: ML 69.3% 예측 → 실제 -1.41%

> ⚠️ **ML 모델 문제점**: 60~70% 예측했지만 모두 손실
> - 초반 시간대(09:30~10:39) 예측 정확도가 낮음
> - 높은 ML 예측값이 실제 승률을 보장하지 못함

---

## 🤖 실시간 거래가 1건만 체결된 이유

### 1. 실시간에서 체결된 거래
- **종목**: 950160 (자원에프티씨)
- **시뮬 신호 시간**: 09:54
- **실제 체결 시간**: 09:56 (2분 지연)
- **체결 가격**: 81,700원
- **사유**: "조건검색 편입종목 (신뢰도: 17.27%)"
- **결과**: 승리 (+3.50%)

### 2. 15건이 미체결된 이유 분석

#### 📌 **패턴 데이터 확인 결과**
```
pattern_data_log/pattern_data_20251128.jsonl 분석:
- 총 167개 패턴 기록
- 대부분의 패턴에서 signal_type = None
- ML 승률 = 0.0%
- 패턴 단계는 있지만 신호 타입이 없음
```

**문제점:**
1. **실시간에서 ML 예측이 작동하지 않음**
   - 패턴 데이터에 ml_win_probability가 0%로 기록
   - signal_type이 None으로 저장됨

2. **신호 감지 로직 차이**
   - 시뮬레이션: 과거 데이터 전체를 사용하여 패턴 분석
   - 실시간: 실시간 캔들 빌더로 점진적 패턴 분석
   - 시뮬레이션에서는 신호가 보이지만 실시간에서는 감지 못함

3. **타이밍 이슈**
   - 실시간은 3분봉 완성 시점에 판단
   - 시뮬레이션은 사후적으로 모든 데이터를 사용
   - 예: 09:54 신호를 실시간에서는 09:57까지 기다려야 확인 가능

4. **조건검색 의존**
   - 실시간 체결 사유: "조건검색 편입종목"
   - 패턴 신호가 아닌 조건검색 결과로 매수
   - 신뢰도 17.27%로 매우 낮은 수치

---

## 🔧 개선이 필요한 사항

### 1. 실시간 ML 예측 활성화
```python
# 현재 상태: ml_win_probability = 0.0%
# 원인: 실시간에서 MLPredictor가 제대로 작동하지 않음

# 확인 필요:
- core/ml_predictor.py의 predict_win_probability() 호출 여부
- pattern_features 전달 시 필수 필드 누락 여부
- ml_model_stratified.pkl 로드 상태
```

### 2. 실시간 패턴 감지 개선
```python
# 시뮬레이션과 실시간의 패턴 감지 로직 통일
# signal_type이 None인 이유 파악 필요

# 확인 필요 파일:
- core/realtime_candle_builder.py
- core/pattern_detector.py (있다면)
- main.py의 패턴 판단 로직
```

### 3. 타이밍 최적화
- 3분봉 완성 대기 시간 단축 방안
- 실시간 캔들 빌더의 조기 신호 감지 기능

### 4. 조건검색과 패턴 신호의 통합
- 현재: 조건검색 편입 → 매수
- 개선: 조건검색 편입 → 패턴 검증 → ML 필터 → 매수

---

## 📈 결론

### 시뮬레이션 vs 실시간 차이의 핵심 원인

1. **ML 예측 미작동** (가장 큰 문제)
   - 실시간: ml_win_probability = 0%
   - 시뮬레이션: 정상 작동 (50~71% 예측값)

2. **패턴 감지 로직 차이**
   - 시뮬레이션: 16건 신호 감지
   - 실시간: 신호 타입 None, ML 예측 없음

3. **데이터 가용성**
   - 시뮬레이션: 완전한 과거 데이터
   - 실시간: 점진적 데이터 축적 + 불완전한 캔들

### 권장 조치

1. **즉시 조치**: 실시간 ML 예측 활성화 확인
2. **단기**: 실시간 패턴 감지 로직 디버깅
3. **중기**: 시뮬레이션과 실시간 로직 통일
4. **장기**: 실시간 타이밍 최적화 및 조기 신호 감지

---

## 🎲 ML 모델 성능 평가 (시뮬레이션 기준)

### 예측 정확도
- **60% 이상 예측 → 실제 승률**: 42.9% (3승 4패)
- **50% 이하 예측 → 차단 효과**: 80% (4/5건 손실 방지)

### ML 모델의 한계
1. 높은 예측값(60~70%)도 패배 가능
2. 초반 시간대 예측 정확도 낮음
3. 50% 예측(패턴없음)은 100% 승률 (우연일 가능성)

### 개선 방향
- 시간대별 가중치 조정
- 초반 거래 필터 강화
- 60% 이상 예측의 신뢰도 재검토
