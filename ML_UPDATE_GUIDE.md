# 📚 ML 모델 업데이트 가이드

ML 모델을 최신 거래 데이터로 업데이트하는 방법을 설명합니다.

---

## 🎯 ML 업데이트가 필요한 이유

- **새로운 시장 상황 반영**: 시장 패턴은 계속 변화합니다
- **승률 개선**: 최근 거래 결과를 학습하여 예측 정확도 향상
- **데이터 축적**: 거래 데이터가 많을수록 모델 성능 향상

---

## 📊 현재 ML 모델 정보 확인

```bash
# 모델 정보만 출력
python ml_daily_update.py --info
```

**출력 예시:**
```
📊 현재 ML 모델 정보
============================================================
파일: ml_model_stratified.pkl
크기: 45,678 bytes
최종 업데이트: 2025-11-18 08:30:15

학습 데이터:
  총 패턴 수: 1,234개
  승리: 567개
  패배: 667개
  승률: 45.9%
  기간: 2025-09-01 ~ 2025-11-18

최근 패턴 데이터:
  20251118: 15개 패턴
  20251117: 12개 패턴
  20251116: 18개 패턴
```

---

## 🔄 ML 모델 업데이트 방법

### 1️⃣ 증분 업데이트 (추천)

**매일 거래 후** 어제 데이터를 추가하여 모델 업데이트

```bash
# 어제 데이터로 업데이트
python ml_daily_update.py

# 특정 날짜 데이터로 업데이트
python ml_daily_update.py --date 20251118
```

**프로세스:**
1. `pattern_data_log/pattern_data_YYYYMMDD.jsonl` 확인
2. 기존 데이터 + 새 데이터로 `ml_dataset.csv` 재생성
3. Stratified 학습으로 `ml_model_stratified.pkl` 업데이트
4. 이전 모델은 `model_backups/` 폴더에 백업

**소요 시간:** 약 1~5분 (데이터 양에 따라)

---

### 2️⃣ 전체 재학습

**최근 N일 데이터**로 완전히 재학습 (시뮬레이션 백테스트 다시 실행)

```bash
# 최근 90일 데이터로 전체 재학습
python ml_daily_update.py --days 90

# 최근 30일 데이터로 전체 재학습
python ml_daily_update.py --days 30
```

**⚠️ 주의:**
- 시뮬레이션 백테스트를 다시 실행하므로 **수 시간 소요**
- 거래 시간 외에 실행 권장

**언제 사용?**
- 모델 성능이 크게 떨어졌을 때
- 시장 상황이 급변했을 때
- 데이터가 오염되었을 때

---

## ⏰ 자동 업데이트 설정 (Windows 작업 스케줄러)

### 설정 방법:

1. **작업 스케줄러 열기**
   - Win + R → `taskschd.msc` 입력

2. **새 작업 만들기**
   - "작업 만들기" 클릭

3. **일반 탭**
   - 이름: `ML 모델 일일 업데이트`
   - "사용자가 로그온할 때만 실행" 선택

4. **트리거 탭**
   - "새로 만들기" 클릭
   - "매일" 선택
   - 시작 시간: `오전 8:00` (장 시작 전)
   - "사용" 체크

5. **작업 탭**
   - "새로 만들기" 클릭
   - 프로그램/스크립트: `D:\GIT\RoboTrader\ml_daily_update.bat`
   - 시작 위치: `D:\GIT\RoboTrader`

6. **조건 탭**
   - "컴퓨터의 AC 전원이 켜져 있을 때만 작업 시작" 해제

7. **확인** 클릭

### 수동 실행 (테스트):

```bash
# 배치 파일 직접 실행
ml_daily_update.bat
```

---

## 📁 데이터 흐름

```
실시간 거래 (bot.py)
  ↓
pattern_data_logger.py
  ↓
pattern_data_log/pattern_data_20251118.jsonl (매일 저장)
  ↓
ml_prepare_dataset.py (모든 JSONL 파일 통합)
  ↓
ml_dataset.csv (전체 학습 데이터)
  ↓
ml_train_model_stratified.py (Stratified 학습)
  ↓
ml_model_stratified.pkl (최신 모델)
  ↓
bot.py (실시간 트레이딩에서 사용)
```

---

## 🔍 로그 확인

### 패턴 데이터 로그:
```bash
# 오늘 수집된 패턴 확인
type pattern_data_log\pattern_data_20251118.jsonl
```

### ML 업데이트 로그:
```bash
# 자동 업데이트 로그 확인
type ml_update_log.txt
```

---

## 💡 베스트 프랙티스

### ✅ 추천 업데이트 주기:

| 거래 빈도 | 업데이트 주기 | 방법 |
|---------|------------|------|
| 매일 거래 | 매일 | 증분 업데이트 (자동) |
| 주 2~3회 거래 | 주 1회 | 증분 업데이트 (수동) |
| 가끔 거래 | 월 1회 | 전체 재학습 (수동) |

### ✅ 데이터 관리:

1. **최소 데이터 기간**: 60일 이상 권장
2. **최대 데이터 기간**: 180일 (6개월) 권장
   - 너무 오래된 데이터는 현재 시장과 맞지 않을 수 있음
3. **백업**: 모델은 자동으로 `model_backups/` 폴더에 백업됨

### ✅ 성능 모니터링:

```bash
# 정기적으로 모델 정보 확인
python ml_daily_update.py --info

# 확인 항목:
# - 학습 데이터 승률: 40~60% 정상 범위
# - 패턴 수: 500개 이상 권장
# - 최신 데이터 날짜: 최근 7일 이내
```

---

## ❓ 문제 해결

### Q: "패턴 데이터 없음" 오류
**A:** 해당 날짜에 거래가 없었거나 패턴 로깅이 비활성화됨
```bash
# 환경 변수 확인 (.env 파일)
ENABLE_PATTERN_LOGGING=true
```

### Q: 모델 성능이 떨어짐
**A:**
1. 최근 데이터로 증분 업데이트 실행
2. 60일 전체 재학습 시도
3. 학습 데이터 품질 확인 (승률 분포)

### Q: 업데이트 시간이 너무 오래 걸림
**A:**
- 증분 업데이트: 1~5분 (정상)
- 전체 재학습: 수 시간 (정상, 백테스트 포함)
- 증분 업데이트만 사용 권장

### Q: 이전 모델로 롤백하고 싶음
**A:**
```bash
# 백업 폴더에서 이전 모델 복사
copy model_backups\ml_model_stratified_20251117_080000.pkl ml_model_stratified.pkl
```

---

## 🎯 요약

```bash
# 일일 루틴 (자동화 권장)
1. 매일 오전 8시: ml_daily_update.bat 자동 실행
2. 어제 거래 패턴 학습
3. 모델 업데이트 완료
4. 오늘 거래에 최신 모델 사용

# 주간 체크
python ml_daily_update.py --info  # 모델 상태 확인

# 월간 최적화
python ml_daily_update.py --days 90  # 분기별 전체 재학습
```

**ML은 살아있는 시스템입니다. 꾸준한 업데이트로 최고의 성능을 유지하세요!** 🚀
