# RoboTrader 시스템 아키텍처

## 프로젝트 개요
주식 단타 거래를 위한 자동화 시스템으로, 한국투자증권(KIS) API를 활용하여 실시간 데이터 수집, 매매 신호 생성, 자동 주문 실행 및 관리를 수행합니다.

## 디렉토리 구조

```
RoboTrader/
├── main.py                 # 메인 실행 파일
├── config/
│   ├── settings.py         # 설정 파일 로더
│   └── key.ini             # API 키 및 계정 정보 (보안)
├── core/                   # 핵심 비즈니스 로직
│   ├── models.py           # 데이터 모델 정의
│   ├── data_collector.py   # 실시간 데이터 수집
│   ├── order_manager.py    # 주문 관리 및 미체결 처리
│   └── telegram_integration.py # 텔레그램 알림 통합
├── api/                    # KIS API 래퍼
│   ├── kis_api_manager.py  # API 통합 관리자
│   ├── kis_auth.py         # 인증 관리
│   ├── kis_account_api.py  # 계좌 조회 API
│   ├── kis_market_api.py   # 시장 데이터 API
│   └── kis_order_api.py    # 주문 실행 API
└── utils/                  # 유틸리티 모듈
    ├── logger.py           # 로깅 설정
    ├── korean_time.py      # 한국 시간/시장 시간 관리
    └── telegram/           # 텔레그램 알림 서비스
        └── telegram_notifier.py
```

## 핵심 컴포넌트

### 1. 메인 시스템 (`main.py`)
- **DayTradingBot**: 전체 시스템의 중앙 컨트롤러
- **주요 기능**:
  - 시스템 초기화 및 종료 관리
  - 비동기 태스크 스케줄링 및 병렬 실행
  - 24시간 운영을 위한 주기적 관리 작업

#### 주요 태스크들
- `_data_collection_task()`: 실시간 데이터 수집
- `_order_monitoring_task()`: 주문 모니터링 및 미체결 처리
- `_trading_decision_task()`: 매매 의사결정 (전략 실행)
- `_system_monitoring_task()`: 시스템 상태 모니터링
- `_telegram_task()`: 텔레그램 알림 서비스

#### 24시간 운영 관리
- **API 재초기화**: 24시간마다 토큰 갱신
- **시장 정보 갱신**: 매일 오전 8시 시장 상태 및 후보 종목 업데이트
- **주기적 상태 로깅**: 30분마다 시스템 상태 기록

### 2. 데이터 모델 (`core/models.py`)
핵심 데이터 구조 정의:

- **Stock**: 종목 정보 및 OHLCV 데이터
- **Order**: 주문 정보 (상태, 체결량, 정정 횟수 등)
- **TradingSignal**: 매매 신호
- **Position**: 포지션 정보
- **TradingConfig**: 거래 설정 (리스크 관리, 타임아웃 등)

### 3. 실시간 데이터 수집 (`core/data_collector.py`)
- **RealTimeDataCollector**: 후보 종목들의 실시간 가격 데이터 수집
- **특징**:
  - 장중에만 데이터 수집 (시장 시간 체크)
  - ThreadPoolExecutor를 활용한 병렬 API 호출
  - 메모리 관리 (최대 1000개 데이터 유지)
  - 설정 가능한 수집 주기 (기본 30초)

### 4. 주문 관리 시스템 (`core/order_manager.py`)
- **OrderManager**: 주문 실행 및 미체결 관리
- **핵심 기능**:
  - 매수/매도 주문 실행
  - 미체결 주문 모니터링 (10초 주기)
  - 타임아웃 기반 자동 취소
  - 가격 정정 로직 (최대 3회)
  - 부분 체결 처리

#### 주문 생명주기 관리
1. 주문 실행 → 미체결 목록 추가
2. 주기적 상태 확인 (체결/부분체결/취소)
3. 타임아웃 또는 완전 체결 시 완료 처리
4. 필요시 가격 정정 (취소 후 재주문)

### 5. KIS API 통합 (`api/kis_api_manager.py`)
- **KISAPIManager**: 모든 KIS API 기능의 통합 인터페이스
- **주요 기능**:
  - 자동 인증 관리 (1시간마다 재인증)
  - API 호출 속도 제한 (60ms 간격)
  - 실패 시 자동 재시도 (최대 3회)
  - 계좌 잔고, 현재가, OHLCV 데이터 조회
  - 주문 실행 및 취소

### 6. 텔레그램 알림 시스템 (`core/telegram_integration.py`)
- **TelegramIntegration**: 거래 시스템과 텔레그램 연동
- **알림 종류**:
  - 시스템 시작/종료
  - 주문 실행/체결/취소
  - 매매 신호 감지
  - 오류 발생
  - 주기적 상태 알림 (30분)
  - 일일 거래 요약

## 시스템 흐름

### 1. 시스템 초기화
```
1. 설정 로드 (TradingConfig)
2. API 매니저 초기화 (토큰 발급)
3. 텔레그램 봇 초기화
4. 후보 종목 설정
5. 데이터 수집기 초기화
```

### 2. 메인 루프 실행
```
병렬 실행되는 태스크들:
├── 데이터 수집 (30초 주기)
├── 주문 모니터링 (10초 주기)  
├── 매매 의사결정 (1분 주기)
├── 시스템 모니터링 (30분 상태 로그)
└── 텔레그램 봇 폴링
```

### 3. 매매 의사결정 과정
```
1. 장중 여부 확인
2. 후보 종목 데이터 검증 (최소 5개 데이터)
3. 매매 전략 실행 (현재: 간단한 상승률 기반)
4. 신호 발생 시 텔레그램 알림
5. 주문 실행 (향후 구현)
```

## 설정 및 보안

### 1. 설정 파일 구조 (`config/key.ini`)
```ini
[KIS]
KIS_BASE_URL = "https://openapi.koreainvestment.com:9443"
KIS_APP_KEY = "your_app_key"
KIS_APP_SECRET = "your_app_secret"
KIS_ACCOUNT_NO = "your_account_number"
KIS_HTS_ID = "your_hts_id"

[TELEGRAM]
enabled = true
token = "your_bot_token"
chat_id = "your_chat_id"
```

### 2. 리스크 관리 설정
- **최대 동시 보유 종목**: 3개
- **종목별 최대 투자 비율**: 30%
- **손절 비율**: 3%
- **익절 비율**: 5%
- **주문 타임아웃**: 매수 5분, 매도 3분
- **최대 정정 횟수**: 3회

## 확장 포인트

### 1. 매매 전략 확장
- `_simple_trading_logic()` 메서드를 전략 모듈로 분리
- 다양한 기술적 지표 기반 전략 구현
- 백테스팅 시스템 추가

### 2. 데이터 수집 확장
- 호가창, 체결 내역 등 추가 데이터 수집
- 외부 데이터 소스 연동 (뉴스, 공시 등)
- 데이터베이스 저장 기능

### 3. 포트폴리오 관리
- 동적 포지션 크기 조절
- 섹터별, 테마별 분산 투자
- 리밸런싱 기능

### 4. 모니터링 및 분석
- 웹 대시보드 구현
- 성과 분석 리포트
- 실시간 차트 시각화

## 운영 고려사항

### 1. 안정성
- 예외 처리 및 로깅 체계
- 자동 재시작 메커니즘
- 데이터 무결성 검증

### 2. 성능
- 비동기 처리를 통한 병렬 실행
- API 호출 최적화 (배치 처리, 캐싱)
- 메모리 사용량 관리

### 3. 보안
- API 키 암호화 저장
- 접근 권한 관리
- 감사 로그 기록

### 4. 24시간 운영
- 시장 시간 외 대기 모드
- 주기적 헬스 체크
- 장애 복구 자동화

이 아키텍처는 안정적인 24시간 운영과 향후 기능 확장을 고려하여 설계되었으며, 각 모듈간의 느슨한 결합을 통해 유지보수성을 높였습니다.