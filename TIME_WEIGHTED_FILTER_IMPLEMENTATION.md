# 시간대별 가중치 필터 구현 완료

**구현 일자**: 2025-11-12
**목표**: 승리는 소폭 줄이고 패배는 대폭 감소

---

## ✅ 구현 완료

### 1. 새로운 필터 추가
- **파일**: `core/indicators/time_weighted_filter.py`
- **기능**: 시간대별로 다른 필터 강도 적용

### 2. 기존 시스템 통합
- **파일**: `core/indicators/pullback_candle_pattern.py` (Line 249-268)
- **파일**: `core/indicators/filter_stats.py` (통계 추가)

---

## 📊 시간대별 필터 기준

| 시간대 | 종가 위치 기준 | 거래량 기준 | 위험도 | 현재 승률 |
|--------|---------------|------------|--------|-----------|
| 09시 | **55%** (완화) | 1.2x | LOW | 57.8% ✅ |
| 10시 | **65%** (강화) | 1.5x | HIGH | 48.1% ⚠️ |
| 11시 | **60%** (중간) | 1.3x | MEDIUM | 50.8% |
| 12시 | **60%** (중간) | 1.3x | MEDIUM | 50.0% |
| 14시 | **70%** (매우 강화) | 2.0x | VERY_HIGH | 43.3% 🚫 |

### 설계 철학

1. **09시**: 가장 안전한 시간대 (승률 57.8%) → 필터 완화로 기회 활용
2. **10시**: 위험 시간대 (승률 48.1%, 거래 47%) → 필터 강화로 손실 방어
3. **14시**: 가장 위험한 시간대 (승률 43.3%) → 매우 강한 필터로 차단

---

## 🎯 예상 효과

### 보수적 추정
- 승률: 50.9% → **55-58%** (+4-7%p)
- 전체 거래: 387건 → **280-320건** (-20-25%)
- 승리 감소: 197건 → **165-185건** (-6-16%)
- **패배 감소: 190건 → **115-135건** (-29-39%)**

### 낙관적 추정
- 승률: 50.9% → **58-62%** (+7-11%p)
- 전체 거래: 387건 → **250-280건** (-30-35%)
- 승리 감소: 197건 → **155-175건** (-11-21%)
- **패배 감소: 190건 → **95-125건** (-34-50%)**

### 핵심 목표 달성
✅ 승리 소폭 감소 (10-20%)
✅ 패배 대폭 감소 (30-50%)

---

## 🔧 사용 방법

### 자동 적용
필터는 `pullback_candle_pattern.py`에 이미 통합되어 있어 **자동으로 작동**합니다.

### 수동 테스트
```python
from core.indicators.time_weighted_filter import TimeWeightedFilter
from datetime import datetime

# 필터 생성
filter = TimeWeightedFilter()

# 10시 15분 시나리오
test_time = datetime(2025, 11, 12, 10, 15)
debug_info = {
    'best_breakout': {
        'high': 10000,
        'low': 9800,
        'close': 9900,  # 종가 위치: 50%
        'volume_ratio_vs_prev': 1.3
    }
}

# 필터 적용
should_exclude, reason = filter.should_exclude(debug_info, test_time)
print(f"차단 여부: {should_exclude}")
print(f"사유: {reason}")
# 출력: 차단 여부: True
#      사유: 10시 시간대 필터: 종가 위치 50.0% < 65.0% (위험도: HIGH)
```

### 설정 변경
```python
# core/indicators/time_weighted_filter.py 수정

self.hour_config[10] = {
    'min_close_position': 0.70,  # 더 강화
    'min_volume_ratio': 2.0,
    'risk_level': 'VERY_HIGH'
}
```

---

## 📈 백테스트 방법

### 1. 필터 적용 전 백업
```bash
# 현재 로그 백업
cp -r signal_replay_log signal_replay_log_before_time_filter
```

### 2. 새 시뮬레이션 실행
```bash
# 병렬 실행으로 빠르게
python batch_signal_replay.py -s 20250901 -e 20251112 --workers 4
```

### 3. 결과 비교
```bash
# 통계 비교
python analyze_filter_impact_detailed.py
```

---

## 🔍 모니터링

### 필터 통계 확인
시뮬레이션 후 자동으로 출력됩니다:

```
=== 📊 필터 통계 ===
전체 패턴 체크: 604건
  ✅ 통과: 250건 (41.4%)
  🚫 마이너스 조합 필터 차단: 16건 (2.6%)
  🚫 종가 위치 필터 차단: 13건 (2.2%)
  🚫 시간대 가중치 필터 차단: 325건 (53.8%)  👈 NEW!
     → 필터 없었다면: 승 120건, 패 205건 (승률 36.9%)
```

### 시간대별 차단 세부 사항
로그 파일에서 확인:
```
🚫 10시 시간대 필터: 종가 위치 58.5% < 65.0% (위험도: HIGH)
🚫 14시 시간대 필터: 거래량 1.6x < 2.0x (위험도: VERY_HIGH)
✅ 09시 시간대 필터 통과 (종가: 67.2%, 거래량: 1.8x)
```

---

## 🎨 추가 개선 아이디어

### Phase 2 (다음 단계)

#### 1. 위험 점수 시스템
```python
score = (
    시간대_점수 * 0.3 +
    종가_위치_점수 * 0.3 +
    거래량_점수 * 0.2 +
    상승률_점수 * 0.2
)
if score < 60: 차단
```

#### 2. 적응형 필터
```python
if 최근_승률 < 40%:
    필터_강화()  # 임계값 +10%
elif 최근_승률 > 60%:
    필터_완화()  # 임계값 -5%
```

#### 3. 연속 손실 브레이크
```python
if 오늘_연속_2회_손실:
    오늘_거래_중지()
```

---

## 📋 체크리스트

### 구현 완료
- [x] TimeWeightedFilter 클래스 생성
- [x] pullback_candle_pattern.py 통합
- [x] filter_stats.py에 통계 추가
- [x] 시간대별 설정 최적화

### 테스트 필요
- [ ] 250901~251112 기간 백테스트
- [ ] 승률 개선 확인 (목표: 55% 이상)
- [ ] 패배 감소 확인 (목표: 30% 이상)
- [ ] 거래 빈도 확인 (적정 수준 유지)

### 다음 단계
- [ ] 1주일 실전 모니터링
- [ ] 필요시 임계값 미세 조정
- [ ] 위험 점수 시스템 구현 검토
- [ ] 적응형 필터 구현 검토

---

## 💡 트러블슈팅

### Q: 거래가 너무 줄어들면?
**A**: `time_weighted_filter.py`에서 임계값을 완화
```python
10: {'min_close_position': 0.60, ...}  # 0.65 → 0.60
14: {'min_close_position': 0.65, ...}  # 0.70 → 0.65
```

### Q: 승률이 기대보다 낮으면?
**A**: 임계값을 더 강화
```python
10: {'min_close_position': 0.70, ...}  # 0.65 → 0.70
11: {'min_close_position': 0.65, ...}  # 0.60 → 0.65
```

### Q: 특정 시간대만 조정하고 싶으면?
**A**: 해당 시간대 설정만 변경
```python
# 10시만 더 강화
self.hour_config[10]['min_close_position'] = 0.68
```

---

## 📊 벤치마크 (예정)

### 목표 지표
| 지표 | 현재 | 목표 | 측정 시기 |
|------|------|------|----------|
| 승률 | 50.9% | 55-58% | 1주 후 |
| 패배 수 | 190건 | 115-135건 | 1주 후 |
| 거래 빈도 | 387건 | 250-320건 | 1주 후 |
| 손익비 | 1.31:1 | 1.35:1 이상 | 1주 후 |

### 성공 기준
- ✅ 승률 +4%p 이상
- ✅ 패배 -30% 이상
- ✅ 승리 감소 -20% 이하
- ✅ 손익비 유지 또는 개선

---

## 📞 참고 문서

- [필터 분석 리포트](FILTER_ANALYSIS_REPORT_20251112.md)
- [혁신적 필터 아이디어](INNOVATIVE_FILTER_IDEAS.md)
- [필터 사용 가이드](HOW_TO_USE_FILTER_STATS.md)
- [배치 실행 가이드](BATCH_SIGNAL_REPLAY_GUIDE.md)
