# Batch Signal Replay 병렬 처리 가이드

## 개요
`batch_signal_replay.py`는 여러 날짜의 시뮬레이션을 병렬로 실행하여 처리 속도를 크게 향상시킵니다.

## 🚀 성능 개선
- **순차 실행**: 1개 날짜당 약 30초 → 100일 = 50분
- **병렬 실행 (4 workers)**: 100일 = 약 12-15분 (**3-4배 빠름**)

## 사용법

### 1. 기본 병렬 실행 (권장)
```bash
python batch_signal_replay.py --start 20250901 --end 20251107
```
- CPU 코어의 절반을 사용 (예: 16코어 → 8개 작업 동시 실행)
- 최대 8개로 제한 (너무 많으면 메모리 부족)

### 2. 병렬 작업 수 지정
```bash
# 4개 작업 동시 실행
python batch_signal_replay.py -s 20250901 -e 20251107 --workers 4

# 최대한 빠르게 (8개 작업)
python batch_signal_replay.py -s 20250901 -e 20251107 --workers 8
```

### 3. 순차 실행 (디버깅용)
```bash
python batch_signal_replay.py -s 20250901 -e 20251107 --serial
```
- 오류 메시지를 명확히 확인하고 싶을 때
- 메모리가 부족할 때

### 4. 시간 범위 지정
```bash
python batch_signal_replay.py -s 20250901 -e 20251107 -t 9:00-15:30
```

## 옵션 설명

| 옵션 | 짧은 형식 | 설명 | 기본값 |
|------|----------|------|--------|
| `--start` | `-s` | 시작 날짜 (YYYYMMDD) | 필수 |
| `--end` | `-e` | 종료 날짜 (YYYYMMDD) | 필수 |
| `--workers` | `-w` | 병렬 작업 수 | CPU 코어/2 (최대 8) |
| `--serial` | - | 순차 실행 | 병렬 실행 |
| `--time-range` | `-t` | 시간 범위 | 9:00-16:00 |
| `--include-weekends` | - | 주말 포함 | 평일만 |

## 권장 설정

### 시스템별 권장 작업 수

| CPU 코어 수 | RAM | 권장 workers | 예상 속도 |
|------------|-----|-------------|----------|
| 4코어 | 8GB | 2 | 2배 빠름 |
| 8코어 | 16GB | 4 | 3-4배 빠름 |
| 16코어 | 32GB | 8 | 5-6배 빠름 |

### 메모리 부족 시
```bash
# workers 수를 줄이기
python batch_signal_replay.py -s 20250901 -e 20251107 --workers 2

# 또는 순차 실행
python batch_signal_replay.py -s 20250901 -e 20251107 --serial
```

## 출력 예시

### 병렬 실행
```
⚙️ 병렬 실행 모드: 4개 작업 동시 실행
처리할 날짜: 47개
   범위: 20250901 ~ 20251107
   시간: 9:00-16:00
   CPU 코어: 16개
======================================================================

🚀 4개 작업으로 병렬 처리 시작...

실행 중: 20250901
실행 중: 20250902
실행 중: 20250903
실행 중: 20250904
✅ 완료: 20250901
진행률: 1/47 (2.1%)
실행 중: 20250905
✅ 완료: 20250902
진행률: 2/47 (4.3%)
...
진행률: 47/47 (100.0%)

======================================================================
배치 처리 완료: 47/47개 성공
```

### 실패한 날짜 표시
```
======================================================================
배치 처리 완료: 45/47개 성공

⚠️ 실패한 날짜 (2개):
   - 20250915
   - 20250922
```

## 주의사항

1. **메모리 사용량**: 각 작업은 독립적인 프로세스로 실행되므로 메모리를 많이 사용합니다.
   - 1개 작업당 약 200-500MB 사용
   - 8개 작업 = 약 1.6-4GB

2. **API 호출 제한**: KIS API는 초당 요청 수 제한이 있을 수 있습니다.
   - 너무 많은 workers는 API 제한에 걸릴 수 있음
   - 권장: 최대 8개

3. **디버깅**: 오류 메시지를 자세히 보려면 `--serial` 옵션 사용

## 필터 통계

병렬 실행 후에도 필터 통계가 자동으로 집계됩니다:

```
=== 📊 필터 통계 ===
전체 패턴 체크: 64건
  ✅ 통과: 35건 (54.7%)
  🚫 마이너스 조합 필터 차단: 16건 (25.0%)
     → 필터 없었다면: 승 2건, 패 14건 (승률 12.5%)
  🚫 종가 위치 필터 차단: 13건 (20.3%)
     → 필터 없었다면: 승 1건, 패 12건 (승률 7.7%)
```

## 문제 해결

### 오류: "메모리 부족"
```bash
# workers 수를 줄이기
python batch_signal_replay.py -s 20250901 -e 20251107 --workers 2
```

### 오류: "API 제한 초과"
```bash
# 순차 실행으로 전환
python batch_signal_replay.py -s 20250901 -e 20251107 --serial
```

### 중간에 중단되었을 때
```bash
# 실패한 날짜만 다시 실행
python batch_signal_replay.py -s 20250915 -e 20250922
```

## 성능 비교

### 순차 실행 (기존)
```bash
python batch_signal_replay.py -s 20250901 -e 20251107 --serial
# 예상 시간: 약 50분
```

### 병렬 실행 (개선)
```bash
python batch_signal_replay.py -s 20250901 -e 20251107 --workers 4
# 예상 시간: 약 12-15분 (3-4배 빠름)
```

### 최대 성능
```bash
python batch_signal_replay.py -s 20250901 -e 20251107 --workers 8
# 예상 시간: 약 8-10분 (5-6배 빠름)
```
