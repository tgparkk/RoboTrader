# 필터 자동 업데이트 시스템 가이드

## 개요

`daily_filter_updater.py`는 매일 거래 결과를 분석하여 `PatternCombinationFilter`를 자동으로 업데이트하는 시스템입니다.

### 주요 기능

1. **패턴 데이터 분석**: `pattern_data_log`에서 4단계 눌림목 패턴의 거래 결과 수집
2. **조합별 수익률 계산**: 상승강도 + 하락정도 + 지지길이 조합별로 수익률 집계
3. **마이너스 조합 필터링**: 총 수익이 마이너스인 조합을 자동으로 찾아내기
4. **필터 코드 자동 생성**: `core/indicators/pattern_combination_filter.py` 자동 업데이트
5. **일일 보고서 생성**: 매일 분석 결과를 마크다운 형식으로 자동 저장 (`filter_reports/`)

---

## 사용 방법

### 1. 특정 날짜 분석

```bash
python daily_filter_updater.py --date 20251114
```

### 2. 날짜 범위 분석

```bash
# 최근 1주일 데이터 분석
python daily_filter_updater.py --start 20251110 --end 20251117

# 9월 전체 분석
python daily_filter_updater.py --start 20250901 --end 20250930
```

### 3. 전체 데이터 분석

```bash
# pattern_data_log의 모든 파일 분석
python daily_filter_updater.py --all
```

### 4. 필터 자동 업데이트

```bash
# 전체 데이터 분석 후 필터 자동 업데이트
python daily_filter_updater.py --all --update
```

---

## 고급 옵션

### 최소 거래 수 설정

기본값은 3건입니다. 최소 거래 수를 변경하려면:

```bash
# 최소 5건 이상인 조합만 분석
python daily_filter_updater.py --all --min-trades 5
```

### 손실 임계값 설정

기본값은 -1.0%입니다. 더 엄격하게 필터링하려면:

```bash
# 총 손실이 -2.0% 이상인 조합만 제외
python daily_filter_updater.py --all --min-loss -2.0
```

---

## 분석 보고서 예시

```
================================================================================
패턴 조합 분석 보고서
================================================================================

총 조합 수: 26개
총 거래 수: 7218건
분석된 조합 (최소 3건 이상): 26개

[+] 양수 수익 조합: 14개
[-] 마이너스 수익 조합: 12개
    -> 필터 대상: 12개

================================================================================
[-] 제외할 조합 상세
================================================================================
조합                                                    거래수      승률       총손실
--------------------------------------------------------------------------------
강함(>6%) + 얕음(<1.5%) + 짧음(≤2)                          882   40.0%  -219.14%
약함(<4%) + 보통(1.5-2.5%) + 짧음(≤2)                       220   37.7%   -85.90%
강함(>6%) + 얕음(<1.5%) + 보통(3-4)                          60   18.3%   -68.87%
...

================================================================================
[*] 상위 수익 조합 (Top 5)
================================================================================
조합                                                    거래수      승률       총수익
--------------------------------------------------------------------------------
약함(<4%) + 얕음(<1.5%) + 짧음(≤2)                         2023   53.0%   682.78%
강함(>6%) + 보통(1.5-2.5%) + 짧음(≤2)                       723   59.5%   680.84%
보통(4-6%) + 보통(1.5-2.5%) + 짧음(≤2)                      544   56.4%   542.66%
...
```

---

## 업데이트 결과 확인

필터가 업데이트되면 다음과 같이 변경됩니다:

### 1. 일일 보고서 생성

```
filter_reports/filter_analysis_20251117.md
```

**매번 실행 시마다 자동으로 생성**되며, 다음 내용을 포함합니다:
- 전체 통계 (조합 수, 거래 수, 승률 등)
- 제외된 조합 상세
- 상위 수익 조합 Top 5
- 지지길이별/상승강도별 패턴 인사이트
- 다음 단계 가이드

### 2. 백업 파일 생성 (--update 시)

```
core/indicators/pattern_combination_filter_backup_20251117_193428.py
```

원본 파일이 자동으로 백업되므로, 필요 시 복원할 수 있습니다.

### 필터 파일 업데이트

`core/indicators/pattern_combination_filter.py`의 `excluded_combinations` 리스트가 자동으로 업데이트됩니다.

```python
# 🚫 제외할 조합 (총 수익 마이너스)
# 자동 생성: 2025-11-17 19:34:28
# 분석 데이터: 26개 조합, 7218건 거래
self.excluded_combinations = [
    # 조합 1: 강함(>6%) + 얕음(<1.5%) + 짧음(≤2)
    # 882건, 승률 40.0%, 총손실 -219.14%
    {
        '상승강도': '강함(>6%)',
        '하락정도': '얕음(<1.5%)',
        '지지길이': '짧음(≤2)',
    },
    ...
]
```

---

## 매일 자동 실행하기

### 방법 1: Windows 작업 스케줄러 사용

1. **작업 스케줄러** 실행
2. **작업 만들기** 클릭
3. **트리거**: 매일 오후 8시 (시뮬레이션 종료 후)
4. **동작**: 프로그램 시작
   - 프로그램: `python`
   - 인수: `D:\GIT\RoboTrader\daily_filter_updater.py --all --update`
   - 시작 위치: `D:\GIT\RoboTrader`

### 방법 2: 배치 스크립트 사용

`update_filter_daily.bat` 파일 생성:

```batch
@echo off
cd /d D:\GIT\RoboTrader
python daily_filter_updater.py --all --update
pause
```

매일 수동으로 실행하거나, 작업 스케줄러에 등록합니다.

---

## 주의사항

### 1. 시뮬레이션 재시작 필요

필터를 업데이트한 후에는 **시뮬레이션을 재시작**해야 변경 사항이 적용됩니다.

### 2. 데이터 누적 시간

- 처음에는 데이터가 적어 정확도가 낮을 수 있습니다
- 최소 **100건 이상의 거래 데이터**가 누적되면 유의미한 결과를 얻을 수 있습니다
- 권장: **1개월 이상의 데이터** 누적 후 사용

### 3. 과적합 방지

- `--min-trades` 옵션을 너무 낮게 설정하면 과적합 위험이 있습니다
- 최소 3~5건 이상의 거래가 있는 조합만 사용하는 것이 좋습니다

### 4. 백업 관리

- 필터 파일의 백업은 자동으로 생성됩니다
- 오래된 백업은 수동으로 정리하세요

---

## 문제 해결

### Q1. "패턴 파일 없음" 오류

**원인**: `pattern_data_log` 디렉토리에 해당 날짜의 파일이 없습니다.

**해결**: 시뮬레이션을 실행하여 패턴 데이터를 생성하세요.

### Q2. "분석된 조합이 없음"

**원인**: 데이터가 부족하거나 `--min-trades` 값이 너무 높습니다.

**해결**:
- 더 많은 데이터를 누적하거나
- `--min-trades` 값을 낮추세요 (예: `--min-trades 2`)

### Q3. "인코딩 오류"

**원인**: Windows 콘솔의 인코딩 문제

**해결**: 콘솔에서 다음 명령 실행 후 재시도
```bash
chcp 65001
```

---

## 패턴 조합 카테고리 설명

### 상승강도 (1단계)

- **약함(<4%)**: 가격 상승률 4% 미만
- **보통(4-6%)**: 가격 상승률 4~6%
- **강함(>6%)**: 가격 상승률 6% 초과

### 하락정도 (2단계)

- **얕음(<1.5%)**: 하락률 1.5% 미만
- **보통(1.5-2.5%)**: 하락률 1.5~2.5%
- **깊음(>2.5%)**: 하락률 2.5% 초과

### 지지길이 (3단계)

- **짧음(≤2)**: 지지 캔들 2개 이하
- **보통(3-4)**: 지지 캔들 3~4개
- **김(>4)**: 지지 캔들 4개 초과

---

## 참고 파일

- **필터 스크립트**: `daily_filter_updater.py`
- **필터 클래스**: `core/indicators/pattern_combination_filter.py`
- **패턴 데이터**: `pattern_data_log/pattern_data_YYYYMMDD.jsonl`
- **시뮬레이션 로그**: `signal_replay_log/signal_new2_replay_YYYYMMDD_9_00_0.txt`
- **일일 보고서**: `filter_reports/filter_analysis_YYYYMMDD.md` ⭐ NEW

---

## 고급 사용 예시

### 최근 2주 데이터로 테스트

```bash
# 분석만 (업데이트 안 함)
python daily_filter_updater.py --start 20251103 --end 20251117

# 결과가 만족스러우면 업데이트
python daily_filter_updater.py --start 20251103 --end 20251117 --update
```

### 월별 비교 분석

```bash
# 9월 데이터 분석
python daily_filter_updater.py --start 20250901 --end 20250930 > report_september.txt

# 10월 데이터 분석
python daily_filter_updater.py --start 20251001 --end 20251031 > report_october.txt

# 11월 데이터 분석
python daily_filter_updater.py --start 20251101 --end 20251130 > report_november.txt
```

### 엄격한 필터링

```bash
# 최소 10건 이상 & 총 손실 -5% 이상인 조합만 제외
python daily_filter_updater.py --all --min-trades 10 --min-loss -5.0 --update
```

---

## 향후 개선 사항

- [ ] 승률 기반 필터링 추가
- [ ] 조합별 기대 수익률 계산
- [ ] 시각화 차트 생성
- [ ] 이메일 알림 기능
- [ ] 웹 대시보드

---

## 라이선스

이 스크립트는 RoboTrader 프로젝트의 일부입니다.

---

**마지막 업데이트**: 2025-11-17
**버전**: 1.0
