# ì¥ ë§ˆê° í›„ ë°ì´í„° ì €ì¥ ì‹œìŠ¤í…œ

## ğŸ“‹ ê°œìš”

ì¥ ë§ˆê° í›„(15:30) ìë™ìœ¼ë¡œ ë¶„ë´‰ ë°ì´í„°ì™€ ì¼ë´‰ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## ğŸ†• ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼

### [core/post_market_data_saver.py](core/post_market_data_saver.py)

ì¥ ë§ˆê° í›„ ë°ì´í„° ì €ì¥ì„ ì „ë‹´í•˜ëŠ” ë…ë¦½ ëª¨ë“ˆì…ë‹ˆë‹¤.

**ì£¼ìš” í´ë˜ìŠ¤:**
- `PostMarketDataSaver`: ë°ì´í„° ì €ì¥ ì „ë‹´ í´ë˜ìŠ¤

**ì£¼ìš” ë©”ì„œë“œ:**

1. **`save_minute_data_to_cache(intraday_manager)`**
   - ë¶„ë´‰ ë°ì´í„°ë¥¼ `cache/minute_data/` í´ë”ì— pkl íŒŒì¼ë¡œ ì €ì¥
   - íŒŒì¼ëª…: `{stock_code}_{date}.pkl` (ì˜ˆ: `000230_20251107.pkl`)
   - ë‹¹ì¼ ë°ì´í„°ë§Œ í•„í„°ë§í•˜ì—¬ ì €ì¥
   - ë°˜í™˜ê°’: `{'total': ì „ì²´, 'saved': ì„±ê³µ, 'failed': ì‹¤íŒ¨}`

2. **`save_minute_data_to_file(intraday_manager)`**
   - ë¶„ë´‰ ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥ (ë””ë²„ê¹…ìš©)
   - íŒŒì¼ëª…: `memory_minute_data_{YYYYMMDD_HHMMSS}.txt`
   - Historical, Realtime, Combined ë°ì´í„° ëª¨ë‘ í¬í•¨
   - ë°˜í™˜ê°’: íŒŒì¼ëª… ë˜ëŠ” None

3. **`save_daily_data(stock_codes, target_date=None, days_back=100)`** âœ¨ **NEW**
   - ì¼ë´‰ ë°ì´í„°ë¥¼ `cache/daily/` í´ë”ì— pkl íŒŒì¼ë¡œ ì €ì¥
   - íŒŒì¼ëª…: `{stock_code}_{target_date}_daily.pkl` (ì˜ˆ: `000230_20251107_daily.pkl`)
   - KIS APIë¡œ ê³¼ê±° 100ì¼ì¹˜ ì¼ë´‰ ë°ì´í„° ì¡°íšŒ ë° ì €ì¥
   - ì´ë¯¸ íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ìŠ¤í‚µ
   - ë°˜í™˜ê°’: `{'total': ì „ì²´, 'saved': ì„±ê³µ, 'failed': ì‹¤íŒ¨}`

4. **`save_all_data(intraday_manager)`** â­ **ë©”ì¸ ë©”ì„œë“œ**
   - ìœ„ 3ê°œ ë©”ì„œë“œë¥¼ ëª¨ë‘ ì‹¤í–‰í•˜ëŠ” í†µí•© ë©”ì„œë“œ
   - ë¶„ë´‰(pkl) + ì¼ë´‰(pkl) + ë¶„ë´‰(txt) ëª¨ë‘ ì €ì¥
   - ë°˜í™˜ê°’: ì „ì²´ ì €ì¥ ê²°ê³¼

## ğŸ”§ ìˆ˜ì •ëœ íŒŒì¼

### [core/intraday_stock_manager.py](core/intraday_stock_manager.py)

**ë³€ê²½ ì‚¬í•­:**

1. **Import ì¶”ê°€** (30ì¤„)
   ```python
   from core.post_market_data_saver import PostMarketDataSaver
   ```

2. **ì´ˆê¸°í™” ì‹œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±** (91ì¤„)
   ```python
   # ğŸ†• ì¥ ë§ˆê° í›„ ë°ì´í„° ì €ì¥ê¸°
   self.data_saver = PostMarketDataSaver()
   ```

3. **15:30 ìë™ ì €ì¥ ë¡œì§ ë³€ê²½** (1243-1249ì¤„)
   ```python
   # ğŸ†• 15:30 ì¥ ë§ˆê° ì‹œ ë©”ëª¨ë¦¬ ë°ì´í„° ìë™ ì €ì¥ (ë¶„ë´‰ + ì¼ë´‰)
   current_time = now_kst()
   if current_time.hour == 15 and current_time.minute >= 30:
       if not hasattr(self, '_data_saved_today'):
           # PostMarketDataSaverë¥¼ í†µí•´ ëª¨ë“  ë°ì´í„° ì €ì¥
           self.data_saver.save_all_data(self)
           self._data_saved_today = True  # í•˜ë£¨ì— í•œ ë²ˆë§Œ ì €ì¥
   ```

4. **ê¸°ì¡´ ë©”ì„œë“œ Deprecated ì²˜ë¦¬** (1549-1568ì¤„)
   - `_save_minute_data_to_cache()` â†’ ìƒˆ ëª¨ë“ˆë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
   - `_save_minute_data_to_file()` â†’ ìƒˆ ëª¨ë“ˆë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

## ğŸ“Š ì €ì¥ë˜ëŠ” ë°ì´í„°

### 1. ë¶„ë´‰ ë°ì´í„° (pkl)
- **ê²½ë¡œ**: `cache/minute_data/{stock_code}_{date}.pkl`
- **ë‚´ìš©**: ë‹¹ì¼ 09:00~15:30 ë¶„ë´‰ ë°ì´í„°
- **ì¶œì²˜**: ë©”ëª¨ë¦¬ì˜ historical + realtime ë³‘í•© ë°ì´í„°

### 2. ì¼ë´‰ ë°ì´í„° (pkl) âœ¨ **NEW**
- **ê²½ë¡œ**: `cache/daily/{stock_code}_{date}_daily.pkl`
- **ë‚´ìš©**: ê³¼ê±° 100ì¼ì¹˜ ì¼ë´‰ ë°ì´í„°
- **ì¶œì²˜**: KIS API ì¡°íšŒ

### 3. ë¶„ë´‰ ë°ì´í„° (txt) - ë””ë²„ê¹…ìš©
- **ê²½ë¡œ**: `memory_minute_data_{YYYYMMDD_HHMMSS}.txt`
- **ë‚´ìš©**: ì „ì²´ ì¢…ëª©ì˜ ë¶„ë´‰ ë°ì´í„° (historical, realtime, combined)
- **ìš©ë„**: ë””ë²„ê¹… ë° ê²€ì¦

## â° ì‹¤í–‰ ì‹œì 

**ìë™ ì‹¤í–‰:**
- 15:30 ì¥ ë§ˆê° ì‹œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë¨
- `intraday_stock_manager.py`ì˜ `_periodic_data_update()` ë©”ì„œë“œì—ì„œ í˜¸ì¶œ
- í•˜ë£¨ì— í•œ ë²ˆë§Œ ì‹¤í–‰ (`_data_saved_today` í”Œë˜ê·¸)

**ìˆ˜ë™ ì‹¤í–‰:**
```python
from core.post_market_data_saver import PostMarketDataSaver
from core.intraday_stock_manager import IntradayStockManager

# IntradayStockManager ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆëŠ” ê²½ìš°
saver = PostMarketDataSaver()
result = saver.save_all_data(intraday_manager)

# ë˜ëŠ” ê°œë³„ ì‹¤í–‰
minute_result = saver.save_minute_data_to_cache(intraday_manager)
daily_result = saver.save_daily_data(['000230', '000815'])  # ì¢…ëª© ì½”ë“œ ë¦¬ìŠ¤íŠ¸
text_file = saver.save_minute_data_to_file(intraday_manager)
```

## ğŸ“ ë¡œê·¸ ì˜ˆì‹œ

```
================================================================================
ğŸ ì¥ ë§ˆê° í›„ ë°ì´í„° ì €ì¥ ì‹œì‘
================================================================================
ğŸ“‹ ëŒ€ìƒ ì¢…ëª©: 5ê°œ
   ì¢…ëª© ì½”ë“œ: 000230, 000815, 010170, 033530, 039200

================================================================================
1ï¸âƒ£ ë¶„ë´‰ ë°ì´í„° pkl ì €ì¥
================================================================================
ğŸ’¾ [000230] ë¶„ë´‰ ìºì‹œ ì €ì¥: 390ê±´ â†’ 000230_20251107.pkl
ğŸ’¾ [000815] ë¶„ë´‰ ìºì‹œ ì €ì¥: 390ê±´ â†’ 000815_20251107.pkl
...
âœ… ë¶„ë´‰ ë°ì´í„° ìºì‹œ ì €ì¥ ì™„ë£Œ: 5/5ê°œ ì¢…ëª© ì„±ê³µ, 0ê°œ ì‹¤íŒ¨

================================================================================
2ï¸âƒ£ ì¼ë´‰ ë°ì´í„° pkl ì €ì¥
================================================================================
ğŸ“¡ [000230] ì¼ë´‰ ë°ì´í„° API ì¡°íšŒ ì¤‘... (20240901 ~ 20251107)
âœ… [000230] ì¼ë´‰ ë°ì´í„° ì €ì¥ ì™„ë£Œ: 100ì¼ì¹˜ (20240801~20251107)
...
âœ… ì¼ë´‰ ë°ì´í„° ì €ì¥ ì™„ë£Œ: 5/5ê°œ ì¢…ëª© ì„±ê³µ, 0ê°œ ì‹¤íŒ¨

================================================================================
3ï¸âƒ£ ë¶„ë´‰ ë°ì´í„° í…ìŠ¤íŠ¸ íŒŒì¼ ì €ì¥ (ë””ë²„ê¹…ìš©)
================================================================================
âœ… ë¶„ë´‰ ë°ì´í„° í…ìŠ¤íŠ¸ íŒŒì¼ ì €ì¥ ì™„ë£Œ: memory_minute_data_20251107_153015.txt

================================================================================
âœ… ì¥ ë§ˆê° í›„ ë°ì´í„° ì €ì¥ ì™„ë£Œ
================================================================================
ğŸ“Š ë¶„ë´‰ ë°ì´í„°: 5/5ê°œ ì €ì¥ ì„±ê³µ
ğŸ“Š ì¼ë´‰ ë°ì´í„°: 5/5ê°œ ì €ì¥ ì„±ê³µ
ğŸ“ í…ìŠ¤íŠ¸ íŒŒì¼: memory_minute_data_20251107_153015.txt
================================================================================
```

## ğŸ”„ ê¸°ì¡´ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±

- ê¸°ì¡´ì˜ `_save_minute_data_to_cache()`, `_save_minute_data_to_file()` ë©”ì„œë“œëŠ” ì—¬ì „íˆ ì‘ë™í•©ë‹ˆë‹¤.
- Deprecated ê²½ê³ ì™€ í•¨ê»˜ ìƒˆë¡œìš´ ëª¨ë“ˆë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë©ë‹ˆë‹¤.
- ê¸°ì¡´ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ ìƒˆ ëª¨ë“ˆì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

## âœ… ì£¼ìš” ê°œì„  ì‚¬í•­

1. **ì¼ë´‰ ë°ì´í„° ìë™ ì €ì¥** âœ¨
   - ê¸°ì¡´: ìˆ˜ë™ìœ¼ë¡œ `save_candidate_data.py` ì‹¤í–‰ í•„ìš”
   - ê°œì„ : 15:30ì— ìë™ìœ¼ë¡œ ì €ì¥

2. **ëª¨ë“ˆ ë¶„ë¦¬**
   - ë°ì´í„° ì €ì¥ ë¡œì§ì„ ë…ë¦½ëœ ëª¨ë“ˆë¡œ ë¶„ë¦¬
   - ìœ ì§€ë³´ìˆ˜ ë° í…ŒìŠ¤íŠ¸ ìš©ì´

3. **í†µí•© ì €ì¥ ë©”ì„œë“œ**
   - `save_all_data()` í•˜ë‚˜ë¡œ ëª¨ë“  ë°ì´í„° ì €ì¥
   - ì¼ê´€ëœ ë¡œê¹… ë° ì—ëŸ¬ ì²˜ë¦¬

4. **ìƒì„¸í•œ ë¡œê¹…**
   - ì €ì¥ ì§„í–‰ ìƒí™©ì„ ë‹¨ê³„ë³„ë¡œ í‘œì‹œ
   - ì„±ê³µ/ì‹¤íŒ¨ í†µê³„ ì œê³µ

## ğŸš¨ ì£¼ì˜ì‚¬í•­

1. **API í˜¸ì¶œ ì œí•œ**
   - ì¼ë´‰ ë°ì´í„°ëŠ” ì¢…ëª©ë‹¹ 1íšŒ API í˜¸ì¶œ
   - ì¢…ëª©ì´ ë§ìœ¼ë©´ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ

2. **íŒŒì¼ ì¤‘ë³µ**
   - ë¶„ë´‰: ë§¤ì¼ ìƒˆë¡œ ì €ì¥ (ë®ì–´ì“°ê¸°)
   - ì¼ë´‰: íŒŒì¼ì´ ìˆìœ¼ë©´ ìŠ¤í‚µ (ë®ì–´ì“°ê¸° ì•ˆí•¨)

3. **ë””ìŠ¤í¬ ê³µê°„**
   - ë¶„ë´‰ pkl: ì¢…ëª©ë‹¹ ì•½ 50-100KB
   - ì¼ë´‰ pkl: ì¢…ëª©ë‹¹ ì•½ 10-20KB
   - í…ìŠ¤íŠ¸ íŒŒì¼: ìˆ˜ MB (ì¢…ëª© ìˆ˜ì— ë¹„ë¡€)

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

```python
# 1. ìˆ˜ë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
from core.post_market_data_saver import PostMarketDataSaver

saver = PostMarketDataSaver()

# ë¶„ë´‰ë§Œ ì €ì¥ (intraday_manager í•„ìš”)
# result = saver.save_minute_data_to_cache(intraday_manager)

# ì¼ë´‰ë§Œ ì €ì¥ (API í˜¸ì¶œ)
result = saver.save_daily_data(['000230', '000815', '010170'])
print(result)

# 2. ì‹¤ì‹œê°„ ì‹œìŠ¤í…œì—ì„œ ìë™ ì‹¤í–‰
# main.pyë¥¼ ì‹¤í–‰í•˜ê³  15:30ê¹Œì§€ ëŒ€ê¸°
# ìë™ìœ¼ë¡œ save_all_data() ì‹¤í–‰ë¨
```

## ğŸ“š ì°¸ê³ 

- ê¸°ì¡´ íŒŒì¼: [save_candidate_data.py](save_candidate_data.py) - ì´ì œëŠ” ë°±í…ŒìŠ¤íŒ…ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©
- ê´€ë ¨ íŒŒì¼: [utils/signal_replay.py](utils/signal_replay.py) - ì‹œë®¬ë ˆì´ì…˜ ì‹œ ë¶„ë´‰ ìºì‹œ ì‚¬ìš©
