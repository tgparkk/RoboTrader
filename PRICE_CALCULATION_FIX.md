# 매수가 계산 로직 수정: 실시간과 시뮬레이션 완전 통일

## 📋 변경 요약

실시간 매매의 매수가 계산 방식을 시뮬레이션과 **완전히 동일하게** 변경했습니다:
- **돌파봉 몸통(시가~종가) 기준 80% 고정**
- 조건별 차등 로직 제거 (주석 처리)

## 🔍 문제점 발견

### 기존 차이점

#### 시뮬레이션 (signal_replay.py)
```python
# support_pattern_analyzer.py:586
entry_price = sig_open + (sig_close - sig_open) * 0.8
```
- **기준**: 돌파봉의 **몸통(시가 ~ 종가)**
- **계산**: 시가 + (종가 - 시가) × 80%

#### 실시간 (price_calculator.py) - 수정 전
```python
# 기존 코드
base_price = sig_low + (sig_high - sig_low) * 0.8
```
- **기준**: 돌파봉의 **전체 범위(저가 ~ 고가)**
- **계산**: 저가 + (고가 - 저가) × 80%

### 차이의 영향

**예시**: 돌파봉이 다음과 같을 때
- 저가: 9,000원
- 시가: 9,200원
- 종가: 9,800원
- 고가: 10,000원

| 환경 | 계산 방식 | 매수가 | 차이 |
|------|-----------|--------|------|
| 시뮬레이션 | 9,200 + (9,800 - 9,200) × 0.8 | **9,680원** | - |
| 실시간 (기존) | 9,000 + (10,000 - 9,000) × 0.8 | **9,800원** | +120원 |

**결과**: 실시간이 시뮬레이션보다 **더 높은 가격**에 매수 (불리한 진입)

## ✅ 수정 내용

### 1. 매수가 계산 단순화 (price_calculator.py:72)

```python
# 변경 전 (복잡한 조건별 차등 로직)
base_price = sig_low + (sig_high - sig_low) * 0.8  # 전체 범위 기준
final_price = PriceCalculator._apply_conditional_pricing(...)  # 조건별 60%~80% 변동

# 변경 후 (시뮬레이션과 완전 동일)
final_price = sig_open + (sig_close - sig_open) * 0.8  # 몸통 기준 80% 고정
```

### 2. 조건별 차등 로직 비활성화 (price_calculator.py:91-188)

```python
# ❌ _apply_conditional_pricing() 함수 전체 주석 처리
# - 거래대금별 차등 (대형주/중형주/소형주)
# - 가격대별 차등 (5천원/1만원/2만원/5만원)
# - 시간대별 차등 (11-13시/14시 이후)
```

## 🎯 변경의 이점

### 1. **시뮬레이션과 실시간 완전 통일**
- 백테스트 결과가 실제 매매에 **100% 동일하게** 반영됨
- 승률 및 손익 예측 신뢰도 최대화
- 전략 검증 및 최적화 용이

### 2. **더 보수적이고 일관된 진입**
- 꼬리(그림자)를 제외하고 몸통만 고려
- 위꼬리가 긴 캔들에서 과도한 고점 매수 방지
- **조건에 관계없이 항상 동일한 비율(80%)** 적용

### 3. **단순하고 합리적인 가격 결정**
- 실제로 마감된 가격 범위(시가~종가) 내에서 진입
- 일시적인 고점/저점(꼬리) 영향 최소화
- 복잡한 조건 로직 제거로 예측 가능성 향상

## 📊 영향 분석

### 긍정적 영향
- ✅ 평균 진입가 하락 → 손익 개선 가능성
- ✅ 체결률 안정화 (과도한 고점 주문 감소)
- ✅ 백테스트 일관성 향상

### 주의사항
- ⚠️ 음봉 돌파 시 시가보다 낮은 가격 계산 가능
  - 현재 코드: `sig_low <= final_price <= sig_high` 검증으로 방지
- ⚠️ 기존 실시간 매매 데이터와 비교 시 가격 차이 발생

## 🧪 테스트 권장사항

1. **시뮬레이션 재실행**
   ```bash
   python utils/signal_replay.py --date 20251020 --export txt
   ```

2. **실시간 매매 모니터링**
   - 첫 매수 신호 발생 시 계산된 가격 확인
   - 로그: `"📊 4/5가 계산(몸통): XXX원 (시가:XXX, 종가:XXX)"`

3. **비교 검증**
   - 동일 종목, 동일 시점의 시뮬레이션 vs 실시간 가격 비교
   - 차이가 5% 이상 발생 시 디버깅 필요

## 📝 변경 일시

- **날짜**: 2025-10-20
- **수정 파일**: `core/price_calculator.py`
- **변경 라인**: 62-77, 92-164

## 🔗 관련 파일

- `core/price_calculator.py` (실시간 매수가 계산)
- `core/indicators/pullback/support_pattern_analyzer.py` (시뮬레이션 매수가 계산)
- `utils/signal_replay.py` (시뮬레이션 실행)

---

## 📐 최종 계산 공식

### 시뮬레이션과 실시간 모두 동일:
```python
매수가 = 돌파봉_시가 + (돌파봉_종가 - 돌파봉_시가) × 0.8
```

**더 이상의 조건별 변동 없음 - 항상 80% 고정!**

---

**결론**: 실시간 매매가 이제 시뮬레이션과 **완전히 동일한 방식**으로 매수가를 계산합니다. 🎯
